app.controller("MainController", ["$scope", "$rootScope", "$animate", "$alert", "localStorageService",function(scope, rootScope, animate, alert, localStorage) {
    "undefined" == typeof browser_old && (initRipplesWithArrive(), $(document).arrive(".navbar-toggle", function() {
        $(this).sideNav({
            menuWidth: 260,
            closeOnClick: !0
        })
    })),
    scope.theme_colors = ["pink", "red", "purple", "indigo", "blue", "light-blue", "cyan", "teal", "green", "light-green", "lime", "yellow", "amber", "orange", "deep-orange"],
    scope.changeColorTheme = function(color) {
    	scope.theme.color = color
    },
    scope.changeTemplateTheme = function(template) {
    	scope.theme.template = template
    },
    localStorage.get("theme") || (theme = {
        color: "theme-pink",
        template: "theme-template-dark"
    },
    localStorage.set("theme", theme)),
    localStorage.bind(scope, "theme");
    
    var noShowUseChromeNotifyFlag = 0;
    rootScope.noShowUseChromeNotify = function(){
    	noShowUseChromeNotifyFlag = !noShowUseChromeNotifyFlag;
    	noShowUseChromeNotifyFlag?localStorage.set("checkBrowser", 1):localStorage.remove("checkBrowser");
    }
    if(!localStorage.get("checkBrowser")) {
    	var isChrome = window.navigator.userAgent.indexOf("Chrome"), isEdge = window.navigator.userAgent.indexOf("Edge");
    	if(!(isChrome >= 0 && isEdge < 0)) alert({
    		title: "重要提示",
    		content: "为了更好的使用系统，强烈建议您使用谷歌浏览器访问。",
    		placement: "top",
    		type: "theme",
    		show: 1,
    		template: "tpl/use-chrome.jspx",
    		animation: "mat-grow-top-right"
    	});
    }
    scope.loading = false
}]),

app.controller("DashboardController", function($rootScope, $scope, $aside) {
	$rootScope.pageTitle = "全局监控（GIS）";
	var pumpBaseInfoForm = $aside({
        scope: $scope,
        template: "tpl/form-base.jspx",
        show: !1,
        placement: "left",
        backdrop: !1,
        animation: "am-slide-left"
    });
	
	$scope.pump = {};
	$scope.baseInfo = function(name) {
		pumpBaseInfoForm.show(),
		$scope.pump.pumpName = name
    }
}),

app.controller("AreaController", function($scope, $aside, $http) {
	$scope.$on("$destroy", function() {
    })
}),


app.controller("UserController", ["$scope", "$aside", "$http", "layerService", function(scope, aside, http, layerService) {
	http.get("auth/user-data.jspx").success(function (response) {
		scope.data = response.data;
		angular.forEach(scope.data, function(a) {
            a.selected = !1;
        })
	});
    var creatForm = aside({
        scope: scope,
        template: "tpl/form-user-create.jspx",
        show: !1,
        placement: "left",
        backdrop: !1,
        animation: "am-slide-left"
    }),
    
    updateForm = aside({
        scope: scope,
        template: "tpl/form-user-update.jspx",
        show: !1,
        placement: "left",
        backdrop: !1,
        animation: "am-slide-left"
    }),
    
    detailForm = aside({
        scope: scope,
        template: "tpl/form-user-detail.jspx",
        show: !1,
        placement: "left",
        backdrop: !1,
        animation: "am-slide-left"
    }),
    
    showCreatForm = function() {
        angular.element(".tooltip").remove(),
        hideAllForm(),
        creatForm.show()
    },
    hideCreatForm = function() {
    	creatForm.hide()
    },
    showUpdateForm = function() {
        angular.element(".tooltip").remove(),
        hideAllForm(),
        updateForm.show()
    },
    hideUpdateForm = function() {
    	updateForm.hide()
    },
    showDetailForm = function() {
        angular.element(".tooltip").remove(),
        hideAllForm(),
        detailForm.show()
    },
    hideDetailForm = function() {
    	detailForm.hide()
    },
    hideAllForm = function() {
    	creatForm.hide(),
    	updateForm.hide(),
    	detailForm.hide()
    };
    
    scope.keyword = "",
    
    scope.checkAll = function() {
        angular.forEach(scope.data, function(item) {
        	item.selected = scope.selectAll
        })
    },

    scope.create = function() {
    	http.get("auth/role-data.jspx").success(function(response) {
    		scope.roles = response.data,
            scope.user = {},
            scope.cmd = 'create',
            showCreatForm()
    	});
    },
    
    scope.save = function() {
    	scope.user.roleId = scope.roles.selected.roleId;
    	"create" === scope.cmd && http({
    		method: 'post',
    		url: 'auth/add-user.jspx',
    		data: scope.user
    	}).success(function(req) {
    		console.log(req);
    		if(req.success) {
    			scope.data.push(req.user),
        		hideCreatForm()
    		} else {
    			layerService.layerAlert(req.message)
    		}
    	})
    },
    
    scope.edit = function(user) {
    	user && http.get("auth/role-data.jspx").success(function(response) {
    		scope.roles = response.data;
    		angular.forEach(scope.roles, function(role) {
    			if(role.roleId == user.roleId){
    				scope.roles.selected = role
    			}
            });
            scope.user = angular.copy(user),
            scope.cmd = 'update',
            showUpdateForm()
    	});
    },
    
    scope.update = function() {
    	"update" === scope.cmd && http({
    		method: 'post',
    		url: 'auth/change-user.jspx',
    		data: {
        		userId: scope.user.userId,
        		userName: scope.user.userName,
        		userLoginName: scope.user.userLoginName,
        		userPhone: scope.user.userPhone,
        		roleId: scope.roles.selected.roleId,
        	}
    	}).success(function(req) {
    		if(req.success) {
    			scope.data.forEach(function(user,index,arr){
				  if(user.userId == req.user.userId) {
					  arr[index] = req.user;
				  }          
				}),
        		hideUpdateForm()
    		} else {
    			layerService.layerAlert(req.message)
    		}
    	})
    },
    
    scope.toggleUserStatus = function(user) {
    	user && http({
    		method: 'post',
    		url: 'auth/toggle-user-status.jspx',
    		data: {
        		userId: user.userId,
        		userDisableStatus: user.userDisableStatus
        	}
    	}).success(function(req) {
    		if(req.success) {
    			(user.userDisableStatus = !user.userDisableStatus)
    		} else {
    			layerService.layerAlert(req.message)
    		}
    	})
    },
    
    scope.remove = function(user) {
    	user && layerService.layerConfirm("确认要删除该用户吗？", function(){
    		http({
        		method: 'post',
        		url: 'auth/delete-user.jspx',
        		data: {
            		userId: user.userId
            	}
        	}).success(function(req) {
        		if(req.success) {
        			scope.data.splice(scope.data.indexOf(user), 1),scope.$apply()
        		} else {
        			layerService.layerAlert(req.message)
        		}
        	})
    	})
    },
    
    scope.removeMore = function() {
    	var userIds = [];
    	scope.data.forEach(function(user,index,arr){
		  if(user.selected) {
			  userIds.push(user.userId);
		  }
		})
		userIds.length > 0 && layerService.layerConfirm("确认要删除已选择的" + userIds.length + "个用户吗？", function(){
    		http({
        		method: 'post',
        		url: 'auth/delete-users.jspx',
        		data: userIds
        	}).success(function(req) {
        		if(req.success) {
        			layerService.layerAlert("成功删除 " + req.successCount + " 条记录，删除失败 " + req.failCount + " 条记录。" + req.failMessage)
        			scope.data = scope.data.filter(function(user) {
						return ! user.selected
					}), scope.selectAll = !1, scope.$apply()
        		} else {
        			layerService.layerAlert(req.message)
        		}
        	})
    	})
    },
    
    scope.detail = function(user) {
    	user && (http.get("auth/role-data.jspx").success(function(response) {
    		scope.roles = response.data,
    		angular.forEach(scope.roles, function(role) {
    			if(role.roleId == user.roleId){
    				user.roleName = role.roleName
    			}
            });
    		scope.user = user,
    		showDetailForm()
    	}))
    },
    
    scope.$on("$destroy", function() {
    	hideAllForm()
    })
}]),
app.controller("RoleController", ["$scope", "$aside", "$http", "layerService", function(scope, aside, http, layerService) {
    scope.keyword = "",
	http.get("auth/role-data.jspx").success(function(response) {
		scope.data = response.data
	})
	
	authForm = aside({
	    scope: scope,
	    template: "tpl/form-role-auth.jspx",
	    show: !1,
	    placement: "left",
	    backdrop: !1,
	    animation: "am-slide-left"
	}),
	
	showAuthForm = function() {
	    angular.element(".tooltip").remove(),hideAuthForm(),authForm.show()
	},
	hideAuthForm = function() {
		authForm.hide()
	}

    scope.auth = function(role) {
    	scope.role = role,showAuthForm()
    },
    
    scope.$on("$destroy", function() {
    	hideAuthForm()
    })
	
}]);